<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä —Å—Ç–∏–ª—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* (–°–Æ–î–ê –í–°–¢–ê–í–¨–¢–ï –¢–û–¢ –ñ–ï CSS, –ß–¢–û –Ø –î–ê–í–ê–õ –í –ü–†–ï–î–´–î–£–©–ï–ú –û–¢–í–ï–¢–ï) */
        /* –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ —è –Ω–µ –¥—É–±–ª–∏—Ä—É—é CSS, –æ–Ω –∏–¥–µ–Ω—Ç–∏—á–µ–Ω */
        :root {
            --bg-color: var(--tg-theme-bg-color, #212121);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #aaaaaa);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #1c1c1d);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .container {
            padding: 12px;
            padding-bottom: 80px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card:active { transform: scale(0.98); }
        .card.selected { outline: 3px solid var(--button-color); outline-offset: -3px; }

        .image-wrapper {
            width: 100%;
            position: relative;
            padding-top: 150%; 
            background-color: rgba(128,128,128,0.1);
        }

        .card-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card-img.loaded { opacity: 1; }

        .card-info {
            padding: 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            position: absolute;
            bottom: 0; left: 0; right: 0;
        }

        .card-title {
            font-size: 13px; font-weight: 600; color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .checkmark {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px;
            background-color: var(--button-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transform: scale(0.5); transition: all 0.2s; z-index: 10;
        }
        .card.selected .checkmark { opacity: 1; transform: scale(1); }
        .checkmark svg { width: 16px; height: 16px; fill: var(--button-text-color); }

        .main-button {
            position: fixed; bottom: 20px; left: 16px; right: 16px;
            background-color: var(--button-color); color: var(--button-text-color);
            border: none; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: 600; text-align: center; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: translateY(100px);
            transition: transform 0.3s; z-index: 100;
        }
        .main-button.visible { transform: translateY(0); }

        .filters {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 5px;
            scrollbar-width: none;
        }
        .filters::-webkit-scrollbar { display: none; }
        .filter-chip {
            background-color: var(--secondary-bg); padding: 6px 12px; border-radius: 16px;
            font-size: 13px; white-space: nowrap; border: 1px solid transparent; color: var(--text-color);
        }
        .filter-chip.active {
            background-color: rgba(51, 144, 236, 0.15); color: var(--button-color);
            border: 1px solid rgba(51, 144, 236, 0.3);
        }
        .empty-state { text-align: center; padding: 40px; color: var(--hint-color); grid-column: span 2; }
    </style>
</head>
<body>

    <div class="container">
        <div class="filters" id="filters">
            <div class="filter-chip active" onclick="filterStyles('all')">–í—Å–µ</div>
            <div class="filter-chip" onclick="filterStyles('female')">–ñ–µ–Ω—Å–∫–∏–µ</div>
            <div class="filter-chip" onclick="filterStyles('male')">–ú—É–∂—Å–∫–∏–µ</div>
            <div class="filter-chip" onclick="filterStyles('couple')">–ü–∞—Ä–Ω—ã–µ</div>
            <div class="filter-chip" onclick="filterStyles('group')">–ì—Ä—É–ø–ø–æ–≤—ã–µ</div>
            <div class="filter-chip" onclick="filterStyles('child')">–î–µ—Ç—Å–∫–∏–µ</div>
        </div>
        <div class="gallery" id="gallery">
            <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–ª–µ–π...</div>
        </div>
    </div>

    <div class="main-button" id="mainButton" onclick="sendResult()">–í—ã–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let styles = [];
        let selectedStyleId = null;
        
        // 1. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä gender –∏–∑ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, ?gender=female)
        const urlParams = new URLSearchParams(window.location.search);
        const urlGender = urlParams.get('gender');
        
        let activeFilter = (urlGender && urlGender !== 'unisex' && urlGender !== 'None' && urlGender !== 'null') 
                           ? urlGender 
                           : 'all';

        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º JSON —Å –¥–∞–Ω–Ω—ã–º–∏
        async function loadData() {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∂–µ—Å—Ç–∫–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∏–ª–µ–π
                const response = await fetch(`styles.json?v=${new Date().getTime()}`);
                if (!response.ok) throw new Error("Network response was not ok");
                
                styles = await response.json();
                renderGallery();
            } catch (error) {
                document.getElementById('gallery').innerHTML = `<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–ª–µ–π<br>${error.message}</div>`;
            }
        }

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const filters = document.getElementById('filters');
            gallery.innerHTML = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ñ–∏–ª—å—Ç—Ä–æ–≤
            Array.from(filters.children).forEach(chip => {
                const chipText = chip.innerText.toLowerCase();
                const genderMap = translateGender(activeFilter).toLowerCase();
                const isActive = chipText.includes(genderMap) || (activeFilter === 'all' && chip.innerText === '–í—Å–µ');
                chip.classList.toggle('active', isActive);
            });

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            const filteredStyles = activeFilter === 'all' 
                ? styles 
                : styles.filter(s => s.gender === activeFilter || s.gender === 'unisex');

            if (filteredStyles.length === 0) {
                gallery.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å—Ç–∏–ª–µ–π –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ü§∑‚Äç‚ôÇÔ∏è</div>';
                return;
            }

            filteredStyles.forEach(style => {
                const card = document.createElement('div');
                card.className = `card ${selectedStyleId === style.id ? 'selected' : ''}`;
                card.onclick = () => selectStyle(style.id);

                // –ï—Å–ª–∏ image –Ω–µ—Ç, —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É
                const imgUrl = style.image ? style.image : `https://via.placeholder.com/300x450?text=${encodeURIComponent(style.name)}`;

                card.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${imgUrl}" class="card-img" onload="this.classList.add('loaded')" alt="${style.name}">
                    </div>
                    <div class="checkmark">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${style.name}</div>
                    </div>
                `;
                gallery.appendChild(card);
            });
        }

        function filterStyles(gender) {
            activeFilter = gender;
            renderGallery();
        }

        function selectStyle(id) {
            if (selectedStyleId !== id) {
                selectedStyleId = id;
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                renderGallery();
                updateButton();
            }
        }

        function updateButton() {
            const btn = document.getElementById('mainButton');
            if (selectedStyleId) {
                btn.classList.add('visible');
            } else {
                btn.classList.remove('visible');
            }
        }

        function sendResult() {
            if (!selectedStyleId) return;
            tg.sendData(selectedStyleId);
        }

        function translateGender(g) {
            const map = {
                'female': '–ñ–µ–Ω—Å–∫–∏–µ', 'male': '–ú—É–∂—Å–∫–∏–µ', 'couple': '–ü–∞—Ä–Ω—ã–µ',
                'group': '–ì—Ä—É–ø–ø–æ–≤—ã–µ', 'child': '–î–µ—Ç—Å–∫–∏–µ', 'all': '–í—Å–µ'
            };
            return map[g] || '–í—Å–µ';
        }

        // –ó–∞–ø—É—Å–∫
        loadData();

    </script>
</body>
</html>
