<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Выбор стиля</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* (СЮДА ВСТАВЬТЕ ТОТ ЖЕ CSS, ЧТО Я ДАВАЛ В ПРЕДЫДУЩЕМ ОТВЕТЕ) */
        /* Для краткости я не дублирую CSS, он идентичен */
        :root {
            --bg-color: var(--tg-theme-bg-color, #212121);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #aaaaaa);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #1c1c1d);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .container {
            padding: 12px;
            padding-bottom: 80px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card:active { transform: scale(0.98); }
        .card.selected { outline: 3px solid var(--button-color); outline-offset: -3px; }

        .image-wrapper {
            width: 100%;
            position: relative;
            padding-top: 150%; 
            background-color: rgba(128,128,128,0.1);
        }

        .card-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card-img.loaded { opacity: 1; }

        .card-info {
            padding: 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            position: absolute;
            bottom: 0; left: 0; right: 0;
        }

        .card-title {
            font-size: 13px; font-weight: 600; color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .checkmark {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px;
            background-color: var(--button-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transform: scale(0.5); transition: all 0.2s; z-index: 10;
        }
        .card.selected .checkmark { opacity: 1; transform: scale(1); }
        .checkmark svg { width: 16px; height: 16px; fill: var(--button-text-color); }

        .main-button {
            position: fixed; bottom: 20px; left: 16px; right: 16px;
            background-color: var(--button-color); color: var(--button-text-color);
            border: none; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: 600; text-align: center; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: translateY(100px);
            transition: transform 0.3s; z-index: 100;
        }
        .main-button.visible { transform: translateY(0); }

        .filters {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 5px;
            scrollbar-width: none;
        }
        .filters::-webkit-scrollbar { display: none; }
        .filter-chip {
            background-color: var(--secondary-bg); padding: 6px 12px; border-radius: 16px;
            font-size: 13px; white-space: nowrap; border: 1px solid transparent; color: var(--text-color);
        }
        .filter-chip.active {
            background-color: rgba(51, 144, 236, 0.15); color: var(--button-color);
            border: 1px solid rgba(51, 144, 236, 0.3);
        }
        .empty-state { text-align: center; padding: 40px; color: var(--hint-color); grid-column: span 2; }
    </style>
</head>
<body>

    <div id="debug" class="debug-info"></div>

    <div class="container">
        <!-- Фильтры -->
        <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px;">
            <button onclick="filterStyles('all')">Все</button>
            <button onclick="filterStyles('female')">Женские</button>
            <button onclick="filterStyles('male')">Мужские</button>
            <button onclick="filterStyles('couple')">Парные</button>
        </div>

        <div class="gallery" id="gallery">Загрузка...</div>
    </div>

    <script>
        // 1. Инициализация
        const tg = window.Telegram.WebApp;
        
        // Сообщаем телеграму, что приложение готово
        tg.ready();
        tg.expand(); 

        // Настройка главной кнопки (MainButton)
        tg.MainButton.text = "ВЫБРАТЬ СТИЛЬ";
        tg.MainButton.textColor = "#FFFFFF";
        tg.MainButton.color = "#2cab37"; // Зеленый

        let styles = [];
        let selectedStyleId = null;

        // Логгер ошибок на экран (для отладки)
        function logError(msg) {
            const debug = document.getElementById('debug');
            debug.style.display = 'block';
            debug.innerText = "ОШИБКА: " + msg;
        }

        // 2. Загрузка данных
        async function loadData() {
            try {
                // Добавляем random, чтобы не кэшировалось жестко
                const response = await fetch(`styles.json?r=${Math.random()}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                styles = await response.json();
                
                // Фильтр из URL
                const urlParams = new URLSearchParams(window.location.search);
                const gender = urlParams.get('gender') || 'all';
                
                renderGallery(gender);
            } catch (e) {
                logError("Не удалось загрузить styles.json. Проверьте, что файл лежит в репозитории! " + e.message);
            }
        }

        // 3. Рендер
        function renderGallery(filter) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            const filtered = filter === 'all' ? styles : styles.filter(s => s.gender === filter || s.gender === 'unisex');

            if (filtered.length === 0) {
                gallery.innerHTML = '<div style="padding:20px; text-align:center;">Нет стилей</div>';
                return;
            }

            filtered.forEach(style => {
                const card = document.createElement('div');
                card.className = `card ${selectedStyleId === style.id ? 'selected' : ''}`;
                card.onclick = () => selectStyle(style.id);
                
                // Заглушка, если нет картинки
                const img = style.image ? style.image : 'https://placehold.co/300x450?text=No+Image';

                card.innerHTML = `
                    <div class="image-wrapper">
                        <img src="${img}" class="card-img" onload="this.classList.add('loaded')">
                    </div>
                    <div class="card-info">${style.name}</div>
                `;
                gallery.appendChild(card);
            });
        }

        // 4. Логика выбора
        function selectStyle(id) {
            selectedStyleId = id;
            
            // Вибрация (если поддерживается)
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            
            // Перерисовываем, чтобы показать выделение
            // (В реальном проекте лучше менять класс через JS без перерисовки всего, но так проще)
            const urlParams = new URLSearchParams(window.location.search);
            renderGallery(urlParams.get('gender') || 'all');

            // Показываем кнопку "ВЫБРАТЬ"
            if (!tg.MainButton.isVisible) {
                tg.MainButton.show();
            }
        }

        function filterStyles(g) {
            renderGallery(g);
        }

        // 5. ГЛАВНОЕ: Обработка нажатия кнопки "Отправить"
        tg.MainButton.onClick(function() {
            if (!selectedStyleId) {
                tg.showAlert("Выберите стиль!");
                return;
            }
            
            try {
                // ОТПРАВКА ДАННЫХ
                tg.sendData(selectedStyleId); 
            } catch (e) {
                logError("Ошибка sendData: " + e.message);
                // Если мы тестируем в браузере (не в TG), sendData вызовет ошибку или ничего не сделает
                alert("Отправка данных (в браузере не сработает): " + selectedStyleId);
            }
        });

        // Запуск
        loadData();

    </script>
</body>
</html>
