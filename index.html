<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–∞–ª–µ—Ä–µ—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #f4f4f9);
            --text-color: var(--tg-theme-text-color, #222);
            --hint-color: var(--tg-theme-hint-color, #999);
            --button-color: var(--tg-theme-button-color, #0088cc);
            --card-bg: var(--tg-theme-secondary-bg-color, #fff);
            --danger-color: #ff4d4d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-color) 0%, rgba(var(--tg-theme-button-color-rgb, 0, 136, 204), 0.05) 100%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
            min-height: 100vh;
        }

        /* ===== –°–¢–ê–¢–£–° –ó–ê–ì–†–£–ó–ö–ò ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(var(--tg-theme-button-color-rgb, 0, 136, 204), 0.1);
            border-top-color: var(--button-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 14px;
            color: var(--hint-color);
            animation: pulse-text 1.5s ease-in-out infinite;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .loading-progress {
            margin-top: 10px;
            font-size: 12px;
            color: var(--button-color);
            font-weight: 600;
        }

        /* ===== –ö–ê–†–£–°–ï–õ–¨ –ù–û–í–û–°–¢–ï–ô ===== */
        .news-carousel {
            position: relative;
            width: 100%;
            height: 140px;
            overflow: hidden;
            background: var(--card-bg);
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .carousel-container {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%;
        }

        .carousel-slide {
            min-width: 100%;
            height: 100%;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .carousel-slide.gradient-slide {
            background: linear-gradient(135deg, var(--button-color) 0%, rgba(var(--tg-theme-button-color-rgb, 0, 136, 204), 0.7) 100%);
        }

        .carousel-slide.image-slide {
            padding: 0;
            background: #000;
        }

        .carousel-slide.image-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-content {
            text-align: center;
            color: white;
            z-index: 2;
            max-width: 90%;
        }

        .carousel-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .carousel-subtitle {
            font-size: 13px;
            opacity: 0.95;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .carousel-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 3;
        }

        .carousel-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
            cursor: pointer;
        }

        .carousel-dot.active {
            width: 20px;
            border-radius: 3px;
            background: white;
        }

        /* –¢–ê–ë–´ */
        .tabs {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            display: flex;
            padding: 12px 8px 8px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--hint-color);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            margin: 0 2px;
            position: relative;
        }

        .tab.active {
            color: var(--button-color);
            background: rgba(var(--tg-theme-button-color-rgb, 0, 136, 204), 0.1);
            transform: scale(1.02);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            background: var(--button-color);
            border-radius: 2px;
        }

        /* –°–ï–¢–ö–ê - –ø–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px 12px;
        }

        .style-card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .style-card:active {
            transform: translateY(2px) scale(0.98);
        }

        .style-card.selected {
            outline: 3px solid var(--button-color);
            outline-offset: -3px;
            box-shadow: 0 4px 20px rgba(var(--tg-theme-button-color-rgb, 0, 136, 204), 0.3);
        }

        /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô */
        .image-container {
            position: relative;
            width: 100%;
            height: 240px;
            overflow: hidden;
            background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
        }

        .image-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e8e8e8 0%, #f0f0f0 50%, #e8e8e8 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .style-image {
            position: relative;
            width: 100%;
            height: 240px;
            object-fit: cover;
            display: block;
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.3s ease;
            will-change: opacity;
        }

        .style-image.loaded {
            opacity: 1;
        }

        .style-card:hover .style-image.loaded {
            transform: scale(1.05);
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 240px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 1;
        }

        .style-info {
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: var(--card-bg);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .author-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .style-stats {
            font-size: 12px;
            color: var(--hint-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* –•–ò–¢ –∏ –†–ï–ô–¢–ò–ù–ì */
        .hit-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #ff4b1f 0%, #ff9068 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 75, 31, 0.4);
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .stars {
            color: #FFD700;
            font-size: 12px;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .style-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            z-index: 5;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: rgba(255, 77, 77, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(255, 77, 77, 0.4);
        }

        .delete-btn:active {
            transform: scale(0.9);
        }

        .delete-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .empty-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--hint-color);
            font-size: 15px;
            line-height: 1.6;
        }

        .empty-message small {
            display: block;
            margin-top: 12px;
            font-size: 13px;
            color: var(--hint-color);
            opacity: 0.7;
        }

        .loader {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            padding: 80px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(var(--tg-theme-button-color-rgb, 0, 136, 204), 0.1);
            border-top-color: var(--button-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Debug info */
        #debugInfo {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #0f0;
            padding: 10px;
            font-size: 10px;
            border-radius: 8px;
            z-index: 10000;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- –°–¢–ê–¢–£–° –ó–ê–ì–†–£–ó–ö–ò -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∂–∞–µ–º –≥–∞–ª–µ—Ä–µ—é...</div>
        <div class="loading-progress" id="loadingProgress">0%</div>
    </div>

    <!-- –ö–ê–†–£–°–ï–õ–¨ –ù–û–í–û–°–¢–ï–ô -->
    <div class="news-carousel" id="newsCarousel">
        <div class="carousel-container" id="carouselContainer">
            <!-- –°–ª–∞–π–¥—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <div class="carousel-dots" id="carouselDots"></div>
    </div>

    <!-- –¢–ê–ë–´ -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('popular')">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</div>
        <div class="tab" onclick="switchTab('admin')">üëë –†–µ–¥–∞–∫—Ü–∏—è</div>
        <div class="tab" onclick="switchTab('mine')">‚ú® –ú–æ–∏</div>
    </div>

    <!-- –ì–ê–õ–ï–†–ï–Ø -->
    <div class="gallery-grid" id="grid"></div>

    <div id="debugInfo"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.text = "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å";
        tg.MainButton.color = getComputedStyle(document.documentElement).getPropertyValue('--button-color') || '#0088cc';

        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ö–ê–†–£–°–ï–õ–ò (–†–ï–î–ê–ö–¢–ò–†–£–ï–ú–´–ô –ë–õ–û–ö) ==========
        const NEWS_SLIDES = [
            {
                type: 'gradient',
                title: 'üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
                subtitle: '–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä—Ç—Ä–µ—Ç—ã —Å AI',
                gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                action: null
            },
            {
                type: 'gradient',
                title: 'üî• –ê–∫—Ü–∏—è –Ω–µ–¥–µ–ª–∏!',
                subtitle: '–ö—É–ø–∏ 50 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π - –ø–æ–ª—É—á–∏ +10 –≤ –ø–æ–¥–∞—Ä–æ–∫',
                gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                action: { type: 'command', value: '/buy' }
            },
            {
                type: 'gradient',
                title: '‚ö° –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏!',
                subtitle: '–ö–∏–±–µ—Ä–ø–∞–Ω–∫, –ù–µ–æ–Ω –∏ –†–µ—Ç—Ä–æ–≤–µ–π–≤ —É–∂–µ –≤ –≥–∞–ª–µ—Ä–µ–µ',
                gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                action: { type: 'tab', value: 'admin' }
            }
            // –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Å–ª–∞–π–¥—ã —Å—é–¥–∞:
            // –î–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞:
            // {
            //     type: 'gradient',
            //     title: '‚ú® –ó–∞–≥–æ–ª–æ–≤–æ–∫',
            //     subtitle: '–û–ø–∏—Å–∞–Ω–∏–µ',
            //     gradient: 'linear-gradient(135deg, #—Ü–≤–µ—Ç1 0%, #—Ü–≤–µ—Ç2 100%)',
            //     action: { type: 'command', value: '/–∫–æ–º–∞–Ω–¥–∞' }  // –∏–ª–∏ null
            // }
            //
            // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
            // {
            //     type: 'image',
            //     imageUrl: 'https://example.com/banner.jpg',
            //     action: { type: 'url', value: 'https://—Å—Å—ã–ª–∫–∞.com' }  // –∏–ª–∏ null
            // }
        ];

        // ========== –ö–ê–†–£–°–ï–õ–¨ ==========
        let currentSlide = 0;
        let carouselInterval = null;

        function initCarousel() {
            const container = document.getElementById('carouselContainer');
            const dotsContainer = document.getElementById('carouselDots');
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ª–∞–π–¥–æ–≤, —Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å
            if (!NEWS_SLIDES || NEWS_SLIDES.length === 0) {
                document.getElementById('newsCarousel').style.display = 'none';
                return;
            }
            
            NEWS_SLIDES.forEach((slide, index) => {
                // –°–æ–∑–¥–∞–µ–º —Å–ª–∞–π–¥
                const slideEl = document.createElement('div');
                
                if (slide.type === 'image') {
                    slideEl.className = 'carousel-slide image-slide';
                    slideEl.innerHTML = `<img src="${slide.imageUrl}" alt="News">`;
                } else {
                    slideEl.className = 'carousel-slide gradient-slide';
                    slideEl.style.background = slide.gradient;
                    slideEl.innerHTML = `
                        <div class="carousel-content">
                            <div class="carousel-title">${slide.title}</div>
                            <div class="carousel-subtitle">${slide.subtitle}</div>
                        </div>
                    `;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                if (slide.action) {
                    slideEl.onclick = () => handleSlideAction(slide.action);
                }
                
                container.appendChild(slideEl);
                
                // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫—É
                const dot = document.createElement('div');
                dot.className = index === 0 ? 'carousel-dot active' : 'carousel-dot';
                dot.onclick = () => goToSlide(index);
                dotsContainer.appendChild(dot);
            });
            
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (–µ—Å–ª–∏ —Å–ª–∞–π–¥–æ–≤ –±–æ–ª—å—à–µ 1)
            if (NEWS_SLIDES.length > 1) {
                carouselInterval = setInterval(nextSlide, 5000);
            }
        }

        function handleSlideAction(action) {
            if (!action) return;
            
            if (action.type === 'command') {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É
                tg.sendData(JSON.stringify({ action: 'execute_command', command: action.value }));
                tg.close();
            } else if (action.type === 'url') {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º URL
                tg.openLink(action.value);
            } else if (action.type === 'tab') {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–∞–± –≤ –≥–∞–ª–µ—Ä–µ–µ
                switchTab(action.value);
            }
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % NEWS_SLIDES.length;
            updateCarousel();
        }

        function goToSlide(index) {
            currentSlide = index;
            updateCarousel();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫—É
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = setInterval(nextSlide, 5000);
            }
        }

        function updateCarousel() {
            const container = document.getElementById('carouselContainer');
            const dots = document.querySelectorAll('.carousel-dot');
            
            container.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==========
        const imageCache = new Map();
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    loadImage(img);
                    imageObserver.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px'
        });

        function loadImage(img) {
            const src = img.dataset.src;
            if (!src) return;

            if (imageCache.has(src)) {
                img.src = imageCache.get(src);
                img.classList.add('loaded');
                img.previousElementSibling?.remove();
                return;
            }

            const tempImg = new Image();
            tempImg.onload = () => {
                imageCache.set(src, src);
                img.src = src;
                img.classList.add('loaded');
                img.previousElementSibling?.remove();
            };
            tempImg.onerror = () => {
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                img.classList.add('loaded');
                img.previousElementSibling?.remove();
            };
            tempImg.src = src;
        }

        function preloadPriorityImages(count) {
            const images = document.querySelectorAll('.style-image[data-src]');
            Array.from(images).slice(0, count).forEach(img => loadImage(img));
        }

        function getUserId() {
            const debugData = {
                attempts: [],
                source: 'none'
            };

            let userId = null;

            if (tg.initDataUnsafe?.user?.id) {
                userId = String(tg.initDataUnsafe.user.id);
                debugData.source = 'tg.initDataUnsafe';
                debugData.attempts.push({method: 'initDataUnsafe', value: userId});
            }

            if (!userId && tg.initData) {
                try {
                    const params = new URLSearchParams(tg.initData);
                    const userParam = params.get('user');
                    if (userParam) {
                        const userObj = JSON.parse(decodeURIComponent(userParam));
                        if (userObj.id) {
                            userId = String(userObj.id);
                            debugData.source = 'tg.initData';
                            debugData.attempts.push({method: 'initData', value: userId});
                        }
                    }
                } catch (e) {
                    debugData.attempts.push({method: 'initData', error: e.message});
                }
            }

            if (!userId) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlUserId = urlParams.get('user_id');
                if (urlUserId) {
                    userId = String(urlUserId);
                    debugData.source = 'URL';
                    debugData.attempts.push({method: 'URL', value: userId});
                }
            }

            if (!userId) {
                try {
                    const stored = localStorage.getItem('telegram_user_id');
                    if (stored) {
                        userId = String(stored);
                        debugData.source = 'localStorage';
                        debugData.attempts.push({method: 'localStorage', value: userId});
                    }
                } catch (e) {
                    debugData.attempts.push({method: 'localStorage', error: e.message});
                }
            }

            if (userId) {
                try {
                    localStorage.setItem('telegram_user_id', userId);
                } catch (e) {}
            }

            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
                <b>DEBUG INFO</b><br>
                User ID: ${userId || 'NOT FOUND'}<br>
                Source: ${debugData.source}<br>
                Images cached: ${imageCache.size}<br>
                <pre>${JSON.stringify(debugData.attempts, null, 2)}</pre>
            `;

            let tapCount = 0;
            let tapTimer = null;
            document.body.addEventListener('click', () => {
                tapCount++;
                if (tapCount === 3) {
                    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                    tapCount = 0;
                }
                clearTimeout(tapTimer);
                tapTimer = setTimeout(() => tapCount = 0, 600);
            });

            console.log('User ID Detection:', debugData);

            return userId;
        }

        const currentUserId = getUserId();

        // ========== –û–°–ù–û–í–ù–û–ô –ö–û–î ==========
        let currentTab = 'popular';
        let selectedStyleId = null;

        function getRatingHTML(uses) {
            let starsCount = 1;
            if (uses > 50) starsCount = 5;
            else if (uses > 20) starsCount = 4;
            else if (uses > 10) starsCount = 3;
            else if (uses > 5) starsCount = 2;

            let stars = '‚òÖ'.repeat(starsCount) + '‚òÜ'.repeat(5 - starsCount);
            return `<span class="stars">${stars}</span>`;
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            if (typeof GALLERY_STYLES === 'undefined' || GALLERY_STYLES.length === 0) {
                grid.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
                setTimeout(() => {
                    if (typeof GALLERY_STYLES === 'undefined' || GALLERY_STYLES.length === 0) {
                        grid.innerHTML = '<div class="empty-message">–ì–∞–ª–µ—Ä–µ—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ</div>';
                    }
                }, 3000);
                return;
            }

            let displayStyles = [...GALLERY_STYLES];

            // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
            if (currentTab === 'admin') {
                displayStyles = displayStyles.filter(s => s.is_admin === true);
                if (displayStyles.length === 0) {
                    grid.innerHTML = '<div class="empty-message">–ö–æ–ª–ª–µ–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ü–∏–∏ –ø–æ–∫–∞ –ø—É—Å—Ç–∞<br><small>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –ª—É—á—à–∏–µ —Å—Ç–∏–ª–∏!</small></div>';
                    return;
                }
            } else if (currentTab === 'mine') {
                if (!currentUserId) {
                    grid.innerHTML = `
                        <div class="empty-message">
                            ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à ID<br><br>
                            <b>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</b>
                            1. –ó–∞–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é<br>
                            2. –ù–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É /start<br>
                            3. –û—Ç–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é —Å–Ω–æ–≤–∞<br><br>
                            <small>–¢—Ä–æ–π–Ω–æ–π —Ç–∞–ø = –æ—Ç–ª–∞–¥–∫–∞</small>
                        </div>`;
                    return;
                }

                displayStyles = displayStyles.filter(s => {
                    return String(s.creator_id) === String(currentUserId);
                });

                if (displayStyles.length === 0) {
                    grid.innerHTML = '<div class="empty-message">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–≤–æ–∏—Ö —Å—Ç–∏–ª–µ–π<br><small>–°–æ–∑–¥–∞–π—Ç–µ –∏—Ö –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É - –ü—Ä–∏–¥—É–º–∞—Ç—å —Å–≤–æ–π —Å—Ç–∏–ª—å!</small></div>';
                    return;
                }
            }

            // –°–û–†–¢–ò–†–û–í–ö–ê
            if (currentTab === 'popular' || currentTab === 'admin') {
                displayStyles.sort((a, b) => b.uses - a.uses);
            } else {
                displayStyles.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
            }

            // –†–ï–ù–î–ï–† —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
            displayStyles.forEach((style, index) => {
                const card = document.createElement('div');
                card.className = 'style-card';
                card.id = style.id;
                card.style.animationDelay = `${index * 0.05}s`;
                card.onclick = () => selectStyle(style.id);

                let hitBadge = '';
                if (style.uses > 50) {
                    hitBadge = '<div class="hit-badge"><span>üî•</span> –•–ò–¢</div>';
                } else if (style.uses > 20) {
                    hitBadge = '<div class="hit-badge" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">‚≠ê –¢–û–ü</div>';
                }

                let deleteBtn = '';
                if (currentUserId && String(style.creator_id) === String(currentUserId)) {
                    deleteBtn = `
                        <div class="delete-btn" onclick="deleteStyle(event, '${style.id}')">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </div>`;
                }

                let styleType = 'üé® –°—Ç–∏–ª—å';
                if (style.uses > 30) styleType = 'üèÜ –õ–µ–≥–µ–Ω–¥–∞';
                else if (style.uses > 15) styleType = '‚ö° –ü–æ–ø—É–ª—è—Ä–Ω—ã–π';
                else if (style.is_admin) styleType = 'üëë –ü—Ä–µ–º–∏—É–º';

                card.innerHTML = `
                    ${hitBadge}
                    ${deleteBtn}
                    <div class="image-container">
                        <div class="image-placeholder"></div>
                        <div class="image-overlay"></div>
                        <img class="style-image" data-src="${style.img}" alt="${style.author}">
                    </div>
                    <div class="style-tag">${styleType}</div>
                    <div class="style-info">
                        <div class="info-row">
                            <span class="author-name">@${style.author}</span>
                            ${getRatingHTML(style.uses)}
                        </div>
                        <div class="info-row">
                            <div class="style-stats">
                                <span class="stat-item">üíñ ${style.uses}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            const images = grid.querySelectorAll('.style-image[data-src]');
            images.forEach(img => imageObserver.observe(img));

            // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–µ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ä–∞–∑—É
            setTimeout(() => preloadPriorityImages(4), 100);
        }

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            selectedStyleId = null;
            tg.MainButton.hide();
            renderGrid();
        }

        function selectStyle(id) {
            if (selectedStyleId) {
                const old = document.getElementById(selectedStyleId);
                if (old) old.classList.remove('selected');
            }
            selectedStyleId = id;
            const newCard = document.getElementById(id);
            if (newCard) {
                newCard.classList.add('selected');
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            }
            tg.MainButton.show();
        }

        function deleteStyle(event, id) {
            event.stopPropagation();
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('warning');
            }
            tg.showConfirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—Ç–∏–ª—å –Ω–∞–≤—Å–µ–≥–¥–∞?", (confirmed) => {
                if (confirmed) {
                    const data = { action: 'delete_style', style_id: id };
                    tg.sendData(JSON.stringify(data));
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                }
            });
        }

        tg.MainButton.onClick(() => {
            const data = { action: 'use_gallery_style', style_id: selectedStyleId };
            tg.sendData(JSON.stringify(data));
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        });

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –° –ó–ê–ì–†–£–ó–ö–û–ô ==========
        async function initApp() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingProgress = document.getElementById('loadingProgress');
            
            // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += Math.random() * 25;
                if (progress > 90) progress = 90;
                loadingProgress.textContent = Math.round(progress) + '%';
            }, 150);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—É—Å–µ–ª—å
            initCarousel();
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ GALLERY_STYLES (–º–∞–∫—Å–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã)
            let attempts = 0;
            while (typeof GALLERY_STYLES === 'undefined' && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            clearInterval(loadingInterval);
            loadingProgress.textContent = '100%';
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –≥–∞–ª–µ—Ä–µ—é
            renderGrid();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                setTimeout(() => {
                    loadingOverlay.remove();
                }, 500);
            }, 300);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        initApp();
    </script>
</body>
</html>
